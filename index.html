<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EduVlog — Classroom Vlog</title>
  <style>
    :root{--primary:#3b82f6;--muted:#64748b;--bg-light:#f1f5f9; --border-color:#e2e8f0;}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;color:#0f172a;background:var(--bg-light)}
    header{background:linear-gradient(90deg,#1e3a8a,#3730a3);color:white;padding:18px 20px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;border-bottom:4px solid var(--primary);}
    header h1{font-size:20px;margin:0}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    
    /* Store Link Style */
    .store-link {
        background: #f97316;
        color: white;
        padding: 8px 16px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        margin-left: 24px;
        transition: all 0.2s ease;
    }
    .store-link:hover {
        background: #ea580c;
        transform: translateY(-2px);
    }

    /* AUTH UI STYLES */
    #authArea{
      max-width:420px;
      margin: 50px auto;
      background: #0f172a;
      color: #e2e8f0;
      border-radius:16px;
      padding: 32px;
      border: 1px solid #1e293b;
      box-shadow: 0 20px 45px rgba(0,0,0,0.4), 0 0 150px rgba(59,130,246,0.2);
    }
    #authArea .tabs{ display:flex; border-bottom: 1px solid #1e293b; margin-bottom: 24px; }
    #authArea .tab{ flex:1; text-align: center; padding: 12px 0; cursor: pointer; color: var(--muted); border-bottom: 3px solid transparent; transition: all 0.3s ease; font-weight: 600; }
    #authArea .tab.active{ color: white; border-bottom-color: var(--primary); }
    #authArea label { display:block; margin-bottom: 20px; color: #94a3b8; font-size: 14px; }
    #authArea input { width: 100%; background: #1e293b; border: 1px solid #334155; color: white; padding: 12px 14px; border-radius: 8px; margin-top: 8px; font-size: 16px; transition: all 0.3s ease; }
    #authArea input:focus{ outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(59,130,246,0.3); }
    #authArea button { width: 100%; background: linear-gradient(90deg, var(--primary), #6366f1); color: white; border: 0; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 700; transition: all 0.3s ease; }
    #authArea button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(99,102,241,0.4); }
    #authArea .muted{ text-align:center; color: #64748b; }

    /* PROFESSIONAL DASHBOARD UI STYLES */
    .card{ background:white; border-radius:12px; margin-bottom:16px; border: 1px solid var(--border-color); box-shadow: none; }
    .card-header{ padding: 14px 18px; border-bottom: 1px solid var(--border-color); }
    .card-header h3{ margin:0; font-size: 18px; color: #1e293b; }
    .card-body{ padding: 18px; }
    #welcomeCard{ background: linear-gradient(90deg, #3730a3, #1e3a8a); color: white; border: none; padding: 24px; }
    #welcomeCard .muted{ color: #d1d5db; }
    
    .grid{display:grid;grid-template-columns:1fr 360px;gap:24px}
    @media(max-width:880px){.grid{grid-template-columns:1fr}}
    
    button,input[type=button]{background:var(--primary);color:white;border:0;padding:10px 16px;border-radius:8px;cursor:pointer; font-weight: 600; transition: background 0.2s ease;}
    button:hover{ background: #1d4ed8; }
    button.secondary{background:#e2e8f0;color:#0f172a}
    button.secondary:hover{background:#cbd5e1;}
    label { display: block; margin-bottom: 12px; font-weight: 500; }
    input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #cbd5e1;margin-top:6px; background:#f8fafc;}
    input:focus, textarea:focus, select:focus { outline: 2px solid var(--primary); border-color: var(--primary);}
    
    .small{font-size:13px;padding:6px 10px;border-radius:8px}
    
    .post{ padding: 0; }
    .post-header{ display: flex; align-items: flex-start; gap: 12px; padding: 16px; }
    .post-icon{ font-size: 24px; line-height: 1; margin-top: 2px; }
    .post-title-meta{ flex: 1; }
    .post-title-meta strong{ font-size: 18px; color: #1e293b; }
    .post-title-meta .muted{ font-size: 13px; }
    .post-body{ padding: 0 16px 16px; line-height: 1.6; }
    .post-footer{ padding: 16px; border-top: 1px solid var(--border-color); background: #f8fafc; }
    
    .notice{ border-left:4px solid #f97316 }
    .assignment{ border-left:4px solid #06b6d4 }
    .quiz{ border-left:4px solid #10b981 }
    .general{ border-left:4px solid #64748b }

    a.download{display:inline-block;padding:8px 12px;border-radius:6px;border:1px solid #cbd5e1;font-size:13px;text-decoration:none; background: #fff; font-weight: 500; }
    a.download:hover{ border-color: var(--primary); color: var(--primary); }
    .file-list{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    
    .empty{color:var(--muted);text-align:center;padding:32px}

    /* --- CALCULATOR STYLES START --- */
    #calculator { background: #1e293b; padding: 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    #calc-display { background: #0f172a; color: white; font-size: 48px; font-weight: 300; padding: 20px; text-align: right; border-radius: 10px; margin-bottom: 20px; overflow-x: auto; white-space: nowrap; }
    .calc-keys { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .calc-btn { background: #334155; color: white; border: none; border-radius: 8px; padding: 20px; font-size: 20px; font-weight: bold; cursor: pointer; transition: all 0.2s ease; }
    .calc-btn:hover { background: #475569; }
    .calc-btn:active { transform: scale(0.95); }
    .calc-btn.operator { background: #3b82f6; color: white; }
    .calc-btn.operator:hover { background: #2563eb; }
    .calc-btn.function { background: #64748b; color: white; }
    .calc-btn.function:hover { background: #475569; }
    .calc-btn.equals { background: #16a34a; color: white; grid-column: span 2; }
    .calc-btn.equals:hover { background: #15803d; }
    /* --- CALCULATOR STYLES END --- */

    footer{padding:24px;text-align:center;color:var(--muted);font-size:13px; margin-top: 32px; }
    .replyBox{margin-left:14px;margin-top:8px}
  </style>
</head>
<body>
  <header>
    <div style="width:44px;height:44px;border-radius:8px;background:rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;font-weight:700">EV</div>
    <h1>EduVlog — Classroom Vlog</h1>
    <a href="https://learner7602.github.io/personal/" class="store-link">Store</a>
    <div id="userPanel" style="margin-left:auto"></div>
  </header>

  <main class="wrap">
    <div id="authArea">
      <div class="tabs">
        <div id="tabSignIn" class="tab active">Sign In</div>
        <div id="tabRegister" class="tab">Register</div>
      </div>
      <div id="signInForm">
        <label>Email Address<input id="siEmail" type="email" placeholder="you@example.com"/></label>
        <label>Password<input id="siPassword" type="password" placeholder="••••••••"/></label>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="btnSignIn">Sign In</button>
        </div>
        <div id="siMsg" class="muted" style="margin-top:8px; height: 1em;"></div>
      </div>
      <div id="registerForm" style="display:none">
        <label>Full Name<input id="rName" placeholder="John Doe"/></label>
        <label>Email Address<input id="rEmail" type="email" placeholder="you@example.com"/></label>
        <label>Password<input id="rPassword" type="password" placeholder="Minimum 6 characters"/></label>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="btnRegister">Create Account</button>
        </div>
        <div id="rMsg" class="muted" style="margin-top:8px; height: 1em;"></div>
      </div>
    </div>

    <div id="appArea" style="display:none">
      <div class="card" id="welcomeCard">
        <div id="welcomeText"></div>
      </div>

      <div class="grid">
        <section>
          <div id="teacherPanel" class="card" style="display:none">
            <div class="card-header"><h3>Create a New Post</h3></div>
            <div class="card-body">
              <label>Type<select id="postType"><option value="notice">Notice</option><option value="assignment">Assignment</option><option value="quiz">Quiz</option><option value="general">General</option></select></label>
              <label>Title<input id="postTitle" /></label>
              <label>Content<textarea id="postContent" rows="4"></textarea></label>
              <label>Attach Document Link<input id="postLink" placeholder="Paste Google Drive link here" /></label>
              <div style="display:flex;gap:8px;margin-top:12px">
                <button id="btnPublish">Publish</button>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header"><h3>Classroom Feed</h3></div>
            <div class="card-body">
              <div id="postsList"></div>
            </div>
          </div>
        </section>

        <aside>
          <div class="card">
            <div class="card-header"><h3>Calculator</h3></div>
            <div class="card-body">
                <div id="calculator">
                    <div id="calc-display">0</div>
                    <div class="calc-keys">
                        <button class="calc-btn function" data-key="clear">AC</button>
                        <button class="calc-btn function" data-key="backspace">DEL</button>
                        <button class="calc-btn operator" data-key="%">%</button>
                        <button class="calc-btn operator" data-key="/">÷</button>
                        <button class="calc-btn" data-key="7">7</button>
                        <button class="calc-btn" data-key="8">8</button>
                        <button class="calc-btn" data-key="9">9</button>
                        <button class="calc-btn operator" data-key="*">×</button>
                        <button class="calc-btn" data-key="4">4</button>
                        <button class="calc-btn" data-key="5">5</button>
                        <button class="calc-btn" data-key="6">6</button>
                        <button class="calc-btn operator" data-key="-">−</button>
                        <button class="calc-btn" data-key="1">1</button>
                        <button class="calc-btn" data-key="2">2</button>
                        <button class="calc-btn" data-key="3">3</button>
                        <button class="calc-btn operator" data-key="+">+</button>
                        <button class="calc-btn" data-key="0">0</button>
                        <button class="calc-btn" data-key=".">.</button>
                        <button class="calc-btn equals" data-key="=">=</button>
                    </div>
                </div>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </main>

  <footer>EduVlog — Firebase (Auth / Firestore / Storage) demo</footer>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, addDoc, collection, onSnapshot, deleteDoc, serverTimestamp, query, orderBy } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js';

    // --- CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyA9A2J5doC_q6cjI4UwnkSAsvIJ6ZYWxXs",
      authDomain: "eduvlog-ce6e2.firebaseapp.com",
      projectId: "eduvlog-ce6e2",
      storageBucket: "eduvlog-ce6e2.firebasestorage.app",
      messagingSenderId: "619293090769",
      appId: "1:619293090769:web:42df9e82eeb31f5537f6f0",
      measurementId: "G-WGSF33EDSY"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // UI refs
    const tabSignIn = document.getElementById('tabSignIn');
    const tabRegister = document.getElementById('tabRegister');
    const signInForm = document.getElementById('signInForm');
    const registerForm = document.getElementById('registerForm');
    const authArea = document.getElementById('authArea');
    const appArea = document.getElementById('appArea');
    const userPanel = document.getElementById('userPanel');
    const welcomeText = document.getElementById('welcomeText');
    const teacherPanel = document.getElementById('teacherPanel');
    const postsList = document.getElementById('postsList');
    
    // sign in inputs
    const siEmail = document.getElementById('siEmail');
    const siPassword = document.getElementById('siPassword');
    const siMsg = document.getElementById('siMsg');
    const rName = document.getElementById('rName');
    const rEmail = document.getElementById('rEmail');
    const rPassword = document.getElementById('rPassword');
    const rMsg = document.getElementById('rMsg');

    const postType = document.getElementById('postType');
    const postTitle = document.getElementById('postTitle');
    const postContent = document.getElementById('postContent');
    const postLink = document.getElementById('postLink');

    const btnSignIn = document.getElementById('btnSignIn');
    const btnRegister = document.getElementById('btnRegister');
    const btnPublish = document.getElementById('btnPublish');

    // state
    let currentUser = null;
    let currentName = '';
    let isTeacher = false;

    // tabs
    tabSignIn.addEventListener('click', ()=>{ tabSignIn.classList.add('active'); tabRegister.classList.remove('active'); signInForm.style.display='block'; registerForm.style.display='none'; siMsg.textContent=''; rMsg.textContent=''; });
    tabRegister.addEventListener('click', ()=>{ tabRegister.classList.add('active'); tabSignIn.classList.remove('active'); signInForm.style.display='none'; registerForm.style.display='block'; siMsg.textContent=''; rMsg.textContent=''; });

    // Register
    btnRegister.addEventListener('click', async ()=>{
      rMsg.textContent='';
      const name = (rName.value || '').trim();
      const email = (rEmail.value || '').trim();
      const pw = (rPassword.value || '');
      if(!name || !email || pw.length < 6){ rMsg.textContent = 'Enter name, valid email and password (min 6 chars).'; return }
      try{
        const cred = await createUserWithEmailAndPassword(auth, email, pw);
        await setDoc(doc(db, 'users', cred.user.uid), { name, email });
        rMsg.textContent = 'Registered ✅';
      }catch(err){ rMsg.textContent = err.message }
    });

    // Sign in
    btnSignIn.addEventListener('click', async ()=>{
      siMsg.textContent='';
      const email = (siEmail.value || '').trim();
      const pw = (siPassword.value || '');
      if(!email || pw.length < 6){ siMsg.textContent='Enter email and password (min 6 chars).'; return }
      try{ await signInWithEmailAndPassword(auth, email, pw); }
      catch(err){ siMsg.textContent = err.message }
    });

    async function checkIsTeacher(uid){
      if(!uid) return false;
      const tdoc = await getDoc(doc(db, 'teacher', uid));
      return tdoc.exists();
    }

    onAuthStateChanged(auth, async (user)=>{
      currentUser = user;
      if(user){
        const prof = await getDoc(doc(db,'users', user.uid));
        currentName = prof.exists() ? (prof.data().name || user.email) : user.email;
        isTeacher = await checkIsTeacher(user.uid);
        authArea.style.display='none';
        appArea.style.display='block';
        userPanel.innerHTML = `<span style="margin-right:12px">Welcome, <strong>${escapeHtml(currentName)}</strong></span><button id=btnLogout class="small secondary">Logout</button>`;
        document.getElementById('btnLogout').addEventListener('click', ()=> signOut(auth));
        teacherPanel.style.display = isTeacher? 'block':'none';
        welcomeText.innerHTML = `<div class="muted">Signed in as ${isTeacher? 'Teacher' : 'Student'}</div><div style="font-weight:700; font-size: 24px;">${escapeHtml(currentName)}</div>`;
        loadPosts();
        initCalculator(); // Initialize calculator logic
      } else {
        currentName=''; isTeacher=false;
        authArea.style.display='block'; appArea.style.display='none'; userPanel.innerHTML='';
      }
    });

    // Publish post
    btnPublish.addEventListener('click', async ()=>{
      if(!currentUser) return alert('Sign in first');
      if(!isTeacher) return alert('Only teachers can publish');
      const title = postTitle.value.trim();
      const content = postContent.value.trim();
      const link = postLink.value.trim();
      if(!title){ return alert('Title required') }
      try{
        await addDoc(collection(db,'posts'), { title, content, type: postType.value, link: link || null, created: serverTimestamp(), authorUid: currentUser.uid, authorName: currentName });
        postTitle.value=''; postContent.value=''; postLink.value='';
      }catch(err){ alert('Failed to publish: '+err.message) }
    });
    
    function getPostIcon(type){
        switch(type){
            case 'notice': return '📢'; case 'assignment': return '📝'; case 'quiz': return '❓';
            case 'general': return '💬'; default: return '📄';
        }
    }

    function loadPosts(){
      const q = query(collection(db,'posts'), orderBy('created','desc'));
      onSnapshot(q, snap=>{
        postsList.innerHTML='';
        if(snap.empty) { postsList.innerHTML='<div class="empty">No posts yet.</div>'; return }
        snap.forEach(docu=>{
          const p = { id: docu.id, ...docu.data() };
          const el = document.createElement('div'); el.className='post card '+(p.type||'general');
          const dateStr = p.created && p.created.toDate ? p.created.toDate().toLocaleString() : '';
          const icon = getPostIcon(p.type);
          const typeStr = p.type?.charAt(0).toUpperCase() + p.type?.slice(1) || 'General';
          el.innerHTML = `<div class="post-header"><div class="post-icon">${icon}</div><div class="post-title-meta"><strong>${escapeHtml(p.title||'')}</strong><div class="muted">${escapeHtml(typeStr)} • by ${escapeHtml(p.authorName||'Unknown')} • ${dateStr}</div></div><div class="controls" style="margin-left:auto;"></div></div><div class="post-body">${nl2br(escapeHtml(p.content||''))}</div>`;
          const postBody = el.querySelector('.post-body');
          if(p.link){ const fl = document.createElement('div'); fl.className='file-list'; const a = document.createElement('a'); a.href = p.link; a.target = '_blank'; a.className = 'download'; a.textContent = '🔗 Open Document'; fl.appendChild(a); postBody.appendChild(fl); } 
          else if(p.fileUrl){ const fl = document.createElement('div'); fl.className='file-list'; const a = document.createElement('a'); a.href = p.fileUrl; a.target = '_blank'; a.className = 'download'; a.textContent = '📥 '+(p.fileName || 'Download'); a.setAttribute('download', p.fileName || ''); fl.appendChild(a); postBody.appendChild(fl); }
          const ctr = el.querySelector('.controls');
          if(isTeacher){ const del = document.createElement('button'); del.className='small secondary'; del.textContent='Delete'; del.onclick = ()=> deletePost(p.id, p.filePath); ctr.appendChild(del); }
          const postFooter = document.createElement('div'); postFooter.className = 'post-footer'; let footerNeeded = false;
          if(p.type==='assignment'){ footerNeeded = true; const subDiv = document.createElement('div'); if(!isTeacher){ subDiv.innerHTML = `<label>Submit Your Work</label><input type="file" class="subFile" /><textarea class="subText" placeholder="Add notes (optional)"></textarea><div style="margin-top:8px"><button class="submitBtn small">Submit Assignment</button></div>`; const submitBtn = subDiv.querySelector('.submitBtn'); submitBtn.addEventListener('click', async ()=>{ const fileInput = subDiv.querySelector('.subFile'); const text = subDiv.querySelector('.subText').value; try{ let fileInfo = null; if(fileInput.files && fileInput.files[0]){ const f = fileInput.files[0]; const path = `submissions/${p.id}/${currentUser.uid}_${Date.now()}_${sanitizeFilename(f.name)}`; const sRef = storageRef(storage, path); await uploadBytes(sRef, f); const url = await getDownloadURL(sRef); fileInfo = { fileName: f.name, filePath: path, fileUrl: url }; } await addDoc(collection(db,'submissions'), { postId: p.id, postTitle: p.title, uid: currentUser.uid, name: currentName, text, created: serverTimestamp(), ...fileInfo }); alert('Submitted ✅'); fileInput.value=''; subDiv.querySelector('.subText').value=''; }catch(err){ alert('Submit failed: '+err.message) } }); } else { const view = document.createElement('div'); view.innerHTML = `<button class="small">View submissions</button>`; view.querySelector('button').addEventListener('click', ()=> showSubmissionsForPost(p.id)); subDiv.appendChild(view); } postFooter.appendChild(subDiv); }
          if(p.type==='general'){ footerNeeded = true; const cDiv = document.createElement('div'); if(currentUser){ cDiv.innerHTML = `<label>Leave a comment</label><textarea class="cText" placeholder="Write a comment..."></textarea><div style="margin-top:8px"><button class="cBtn small">Post Comment</button></div><div class="cList" style="margin-top:16px"></div>`; const cBtn = cDiv.querySelector('.cBtn'); const cText = cDiv.querySelector('.cText'); const cList = cDiv.querySelector('.cList'); cBtn.addEventListener('click', async ()=>{ const text = cText.value.trim(); if(!text) return; try{ await addDoc(collection(db,'comments'), { postId: p.id, uid: currentUser.uid, name: currentName, text, created: serverTimestamp() }); cText.value=''; }catch(err){ alert('Failed: '+err.message) } }); const cq = query(collection(db,'comments'), orderBy('created','asc')); onSnapshot(cq, snap=>{ const all = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(c => c.postId === p.id); cList.innerHTML = all.length > 0 ? '<h6>Comments</h6>' : ''; const top = all.filter(c => !c.replyTo); top.forEach(tc => { const cmEl = document.createElement('div'); cmEl.className='muted'; cmEl.style.marginBottom='6px'; cmEl.innerHTML = `<strong>${escapeHtml(tc.name||'')}</strong>: ${escapeHtml(tc.text||'')}`; const replies = all.filter(r => r.replyTo === tc.id); if(replies.length){ const rDiv = document.createElement('div'); rDiv.style.marginLeft='18px'; rDiv.style.marginTop='6px'; replies.forEach(r => { const re = document.createElement('div'); re.className='muted'; re.style.marginBottom='4px'; re.innerHTML = `<strong>${escapeHtml(r.name||'')}</strong>: ${escapeHtml(r.text||'')}`; rDiv.appendChild(re); }); cmEl.appendChild(rDiv); } const replyBox = document.createElement('div'); replyBox.className = 'replyBox'; replyBox.innerHTML = `<textarea class="rText" placeholder="Reply..."></textarea><button class="rBtn small">Reply</button>`; replyBox.querySelector('.rBtn').addEventListener('click', async ()=>{ const rText = replyBox.querySelector('.rText').value.trim(); if(!rText) return; try{ await addDoc(collection(db,'comments'), { postId: p.id, uid: currentUser.uid, name: currentName, text: rText, created: serverTimestamp(), replyTo: tc.id }); replyBox.querySelector('.rText').value = ''; }catch(err){ alert('Reply failed: '+err.message) } }); cmEl.appendChild(replyBox); cList.appendChild(cmEl); }); }); } postFooter.appendChild(cDiv); }
          if(footerNeeded) el.appendChild(postFooter);
          postsList.appendChild(el);
        });
      });
    }

    function showSubmissionsForPost(postId){
      const q = query(collection(db,'submissions'), orderBy('created','desc'));
      onSnapshot(q, snap=>{
        const subs = snap.docs.map(d=>({ id:d.id, ...d.data() })).filter(s=>s.postId===postId);
        const overlay = document.createElement('div'); overlay.style.position='fixed'; overlay.style.left=0; overlay.style.top=0; overlay.style.width='100%'; overlay.style.height='100%'; overlay.style.background='rgba(0,0,0,0.5)'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center'; overlay.style.zIndex='100';
        const box = document.createElement('div'); box.style.background='#fff'; box.style.padding='18px'; box.style.borderRadius='12px'; box.style.maxWidth='800px'; box.style.width='90%'; box.style.maxHeight='80%'; box.style.overflow='auto';
        box.innerHTML = `<h3>Submissions for post</h3>`;
        if (subs.length === 0) { box.innerHTML += `<p class="muted">No submissions yet.</p>`; }
        subs.forEach(s=>{ const d = document.createElement('div'); d.className='card'; d.style.marginBottom='8px'; d.innerHTML = `<div class="card-body"><div><strong>${escapeHtml(s.name||s.uid)}</strong> • <span class="muted">${s.created && s.created.toDate? s.created.toDate().toLocaleString() : ''}</span></div><div style="margin-top:6px">${escapeHtml(s.text||'')}</div></div>`; if(s.fileUrl){ const a = document.createElement('a'); a.href=s.fileUrl; a.target='_blank'; a.className='download'; a.textContent='📥 '+s.fileName; a.setAttribute('download', s.fileName); d.querySelector('.card-body').appendChild(a); } if(isTeacher){ const del = document.createElement('button'); del.className='small secondary'; del.style.marginLeft='8px'; del.textContent='Delete Submission'; del.onclick = ()=> deleteSubmission(s.id, s.filePath); d.querySelector('.card-body').appendChild(del); } box.appendChild(d); });
        const close = document.createElement('button'); close.textContent='Close'; close.className='small'; close.style.marginTop='12px'; close.onclick = ()=> document.body.removeChild(overlay); box.appendChild(close);
        overlay.appendChild(box); document.body.appendChild(overlay);
      });
    }

    // --- CALCULATOR SCRIPT START ---
    function initCalculator() {
        const display = document.getElementById('calc-display');
        const keys = document.querySelector('.calc-keys');
        let displayValue = '0';
        let firstValue = null;
        let operator = null;
        let waitingForSecondValue = false;

        function updateDisplay() {
            display.textContent = displayValue;
        }
        updateDisplay();

        function calculate(first, op, second) {
            if (op === '+') return first + second;
            if (op === '-') return first - second;
            if (op === '*') return first * second;
            if (op === '/') return second === 0 ? 'Error' : first / second;
            if (op === '%') return first % second;
            return second;
        }

        keys.addEventListener('click', (e) => {
            const key = e.target;
            const action = key.dataset.key;

            if (!key.matches('button')) return;

            if (!isNaN(action) || action === '.') { // Number or decimal pressed
                if (waitingForSecondValue) {
                    displayValue = action;
                    waitingForSecondValue = false;
                } else {
                    if (displayValue === '0' && action !== '.') {
                        displayValue = action;
                    } else if (action === '.' && displayValue.includes('.')) {
                        return; // Prevent multiple decimals
                    } else {
                        displayValue += action;
                    }
                }
                updateDisplay();
            } else if (['+', '-', '*', '/', '%'].includes(action)) { // Operator pressed
                if (operator && !waitingForSecondValue) {
                    const result = calculate(firstValue, operator, parseFloat(displayValue));
                    displayValue = `${parseFloat(result.toPrecision(12))}`;
                    firstValue = result;
                } else {
                    firstValue = parseFloat(displayValue);
                }
                operator = action;
                waitingForSecondValue = true;
                display.textContent = key.textContent; // VISUAL FIX: Show operator on screen
            } else if (action === '=') { // Equals pressed
                if (firstValue == null || operator == null || waitingForSecondValue) return;
                const result = calculate(firstValue, operator, parseFloat(displayValue));
                if (result === 'Error') {
                    displayValue = 'Error';
                } else {
                    displayValue = `${parseFloat(result.toPrecision(12))}`;
                }
                firstValue = null;
                operator = null;
                waitingForSecondValue = false;
                updateDisplay();
            } else if (action === 'clear') { // AC pressed
                displayValue = '0';
                firstValue = null;
                operator = null;
                waitingForSecondValue = false;
                updateDisplay();
            } else if (action === 'backspace') { // DEL pressed
                displayValue = displayValue.slice(0, -1) || '0';
                updateDisplay();
            }
        });
    }
    // --- CALCULATOR SCRIPT END ---


    async function deletePost(postId, filePath){
      if(!confirm('Delete this post?')) return;
      try{
        if(filePath){ const fRef = storageRef(storage, filePath); await deleteObject(fRef).catch(()=>{}); }
        await deleteDoc(doc(db,'posts',postId));
      }catch(err){ alert('Delete failed: '+err.message) }
    }

    async function deleteSubmission(subId, filePath){
      if(!confirm('Delete this submission?')) return;
      try{
        if(filePath){ const fRef = storageRef(storage, filePath); await deleteObject(fRef).catch(()=>{}); }
        await deleteDoc(doc(db,'submissions', subId));
      }catch(err){ alert('Delete failed: '+err.message) }
    }

    function nl2br(s){ return s.replace(/\n/g,'<br/>'); }
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"]+/g, function(match){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[match]) }); }
    function sanitizeFilename(name){ return name.replace(/[^a-zA-Z0-9._-]/g,'_'); }
  </script>
</body>
</html>

