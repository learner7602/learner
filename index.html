<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EduVlog — Classroom Vlog</title>
  <style>
    :root{--primary:#2b6cb0;--muted:#667085}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;color:#0f172a;background:#f8fafc}
    header{background:linear-gradient(90deg,var(--primary),#4c51bf);color:white;padding:18px 20px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    header h1{font-size:20px;margin:0}
    .wrap{max-width:1100px;margin:18px auto;padding:0 16px}
    .card{background:white;border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(15,23,42,0.06);margin-bottom:12px}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
    @media(max-width:880px){.grid{grid-template-columns:1fr}}
    button,input[type=button]{background:var(--primary);color:white;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
    button.secondary{background:#e2e8f0;color:#0f172a}
    input,textarea,select{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef8;margin-top:6px}
    .muted{color:var(--muted)}
    .small{font-size:13px;padding:6px 8px;border-radius:8px}
    .controls{display:flex;gap:6px;flex-wrap:wrap}
    .file-list{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    a.download{display:inline-block;padding:6px 8px;border-radius:6px;border:1px dashed #cbd5e1;font-size:13px;text-decoration:none}
    .post{border-left:4px solid transparent;padding-left:12px}
    .notice{border-left-color:#f97316}
    .assignment{border-left-color:#06b6d4}
    .quiz{border-left-color:#10b981}
    .empty{color:var(--muted);text-align:center;padding:28px}
    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tab{padding:8px 12px;border-radius:8px;cursor:pointer}
    .tab.active{background:#eef2ff}
    footer{padding:18px;text-align:center;color:var(--muted);font-size:13px}
    .replyBox{margin-left:14px;margin-top:6px}
  </style>
</head>
<body>
  <header>
    <div style="width:44px;height:44px;border-radius:8px;background:rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;font-weight:700">EV</div>
    <h1>EduVlog — Classroom Vlog</h1>
    <div id="userPanel" style="margin-left:auto"></div>
  </header>

  <main class="wrap">
    <div id="authArea" class="card">
      <div class="tabs">
        <div id="tabSignIn" class="tab active">Sign In</div>
        <div id="tabRegister" class="tab">Register</div>
      </div>
      <div id="signInForm">
        <label>Email<input id="siEmail" type="email"/></label>
        <label>Password<input id="siPassword" type="password"/></label>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="btnSignIn">Sign In</button>
        </div>
        <div id="siMsg" class="muted" style="margin-top:8px"></div>
      </div>

      <div id="registerForm" style="display:none">
        <label>Name<input id="rName" /></label>
        <label>Email<input id="rEmail" type="email"/></label>
        <label>Password<input id="rPassword" type="password"/></label>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="btnRegister">Register</button>
        </div>
        <div id="rMsg" class="muted" style="margin-top:8px"></div>
      </div>
    </div>

    <div id="appArea" style="display:none">
      <div class="card" id="welcomeCard">
        <div id="welcomeText"></div>
      </div>

      <div class="grid">
        <section>
          <div id="teacherPanel" class="card" style="display:none">
            <strong>Create Post</strong>
            <label>Type<select id="postType"><option value="notice">Notice</option><option value="assignment">Assignment</option><option value="quiz">Quiz</option><option value="general">General</option></select></label>
            <label>Title<input id="postTitle" /></label>
            <label>Content<textarea id="postContent" rows="4"></textarea></label>

            <!-- CHANGED: teacher should paste a drive/link instead of uploading a file -->
            <label>Attach Document Link<input id="postLink" placeholder="Paste Google Drive link here" /></label>

            <div style="display:flex;gap:8px;margin-top:12px">
              <button id="btnPublish">Publish</button>
            </div>
          </div>

          <div class="card">
            <strong>Posts</strong>
            <div id="postsList" style="margin-top:12px"></div>
          </div>
        </section>

        <aside>
          <div class="card">
            <strong>Activity</strong>
            <div id="activityList" style="margin-top:8px"></div>
          </div>
        </aside>
      </div>
    </div>
  </main>

  <footer>EduVlog — Firebase (Auth / Firestore / Storage) demo</footer>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, addDoc, collection, onSnapshot, deleteDoc, serverTimestamp, query, orderBy } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js';

    // --- CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyA9A2J5doC_q6cjI4UwnkSAsvIJ6ZYWxXs",
      authDomain: "eduvlog-ce6e2.firebaseapp.com",
      projectId: "eduvlog-ce6e2",
      storageBucket: "eduvlog-ce6e2.firebasestorage.app",
      messagingSenderId: "619293090769",
      appId: "1:619293090769:web:42df9e82eeb31f5537f6f0",
      measurementId: "G-WGSF33EDSY"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // UI refs
    const tabSignIn = document.getElementById('tabSignIn');
    const tabRegister = document.getElementById('tabRegister');
    const signInForm = document.getElementById('signInForm');
    const registerForm = document.getElementById('registerForm');
    const authArea = document.getElementById('authArea');
    const appArea = document.getElementById('appArea');
    const userPanel = document.getElementById('userPanel');
    const welcomeText = document.getElementById('welcomeText');
    const teacherPanel = document.getElementById('teacherPanel');
    const postsList = document.getElementById('postsList');
    const activityList = document.getElementById('activityList');

    // sign in inputs
    const siEmail = document.getElementById('siEmail');
    const siPassword = document.getElementById('siPassword');
    const siMsg = document.getElementById('siMsg');
    const rName = document.getElementById('rName');
    const rEmail = document.getElementById('rEmail');
    const rPassword = document.getElementById('rPassword');
    const rMsg = document.getElementById('rMsg');

    const postType = document.getElementById('postType');
    const postTitle = document.getElementById('postTitle');
    const postContent = document.getElementById('postContent');

    // CHANGED: replaced file input reference with link input for teacher posts
    const postLink = document.getElementById('postLink');

    const btnSignIn = document.getElementById('btnSignIn');
    const btnRegister = document.getElementById('btnRegister');
    const btnPublish = document.getElementById('btnPublish');

    // state
    let currentUser = null;
    let currentName = '';
    let isTeacher = false;

    // tabs
    tabSignIn.addEventListener('click', ()=>{ tabSignIn.classList.add('active'); tabRegister.classList.remove('active'); signInForm.style.display='block'; registerForm.style.display='none'; siMsg.textContent=''; rMsg.textContent=''; });
    tabRegister.addEventListener('click', ()=>{ tabRegister.classList.add('active'); tabSignIn.classList.remove('active'); signInForm.style.display='none'; registerForm.style.display='block'; siMsg.textContent=''; rMsg.textContent=''; });

    // Register
    btnRegister.addEventListener('click', async ()=>{
      rMsg.textContent='';
      const name = (rName.value || '').trim();
      const email = (rEmail.value || '').trim();
      const pw = (rPassword.value || '');
      if(!name || !email || pw.length < 6){ rMsg.textContent = 'Enter name, valid email and password (min 6 chars).'; return }
      try{
        const cred = await createUserWithEmailAndPassword(auth, email, pw);
        await setDoc(doc(db, 'users', cred.user.uid), { name, email });
        rMsg.textContent = 'Registered ✅';
      }catch(err){ rMsg.textContent = err.message }
    });

    // Sign in
    btnSignIn.addEventListener('click', async ()=>{
      siMsg.textContent='';
      const email = (siEmail.value || '').trim();
      const pw = (siPassword.value || '');
      if(!email || pw.length < 6){ siMsg.textContent='Enter email and password (min 6 chars).'; return }
      try{ await signInWithEmailAndPassword(auth, email, pw); }
      catch(err){ siMsg.textContent = err.message }
    });

    async function checkIsTeacher(uid){
      if(!uid) return false;
      const tdoc = await getDoc(doc(db, 'teacher', uid));
      return tdoc.exists();
    }

    onAuthStateChanged(auth, async (user)=>{
      currentUser = user;
      if(user){
        const prof = await getDoc(doc(db,'users', user.uid));
        currentName = prof.exists() ? (prof.data().name || user.email) : user.email;
        isTeacher = await checkIsTeacher(user.uid);
        authArea.style.display='none';
        appArea.style.display='block';
        userPanel.innerHTML = `<span style="margin-right:12px">Welcome, <strong>${escapeHtml(currentName)}</strong> (${isTeacher? 'teacher':'student'})</span><button id=btnLogout class="small secondary">Logout</button>`;
        document.getElementById('btnLogout').addEventListener('click', ()=> signOut(auth));
        teacherPanel.style.display = isTeacher? 'block':'none';
        welcomeText.innerHTML = `<div class="muted">Signed in as</div><div style="font-weight:700">${escapeHtml(currentName)} — ${isTeacher? 'Teacher' : 'Student'}</div>`;
        loadPosts(); loadActivity();
      } else {
        currentName=''; isTeacher=false;
        authArea.style.display='block'; appArea.style.display='none'; userPanel.innerHTML='';
      }
    });

    // Publish post
    btnPublish.addEventListener('click', async ()=>{
      if(!currentUser) return alert('Sign in first');
      if(!isTeacher) return alert('Only teachers can publish');
      const title = postTitle.value.trim();
      const content = postContent.value.trim();
      const link = postLink.value.trim(); // teacher-provided link
      if(!title){ return alert('Title required') }
      try{
        // store link (if provided) in the post doc; no storage upload for teacher side
        await addDoc(collection(db,'posts'), { title, content, type: postType.value, link: link || null, created: serverTimestamp(), authorUid: currentUser.uid, authorName: currentName });
        postTitle.value=''; postContent.value=''; postLink.value='';
      }catch(err){ alert('Failed to publish: '+err.message) }
    });

    // load posts
    function loadPosts(){
      const q = query(collection(db,'posts'), orderBy('created','desc'));
      onSnapshot(q, snap=>{
        postsList.innerHTML='';
        if(snap.empty) { postsList.innerHTML='<div class="empty">No posts yet.</div>'; return }
        snap.forEach(docu=>{
          const p = { id: docu.id, ...docu.data() };
          const el = document.createElement('div'); el.className='post card '+(p.type||'');
          const dateStr = p.created && p.created.toDate ? p.created.toDate().toLocaleString() : '';
          el.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <strong>${escapeHtml(p.title||'')}</strong>
                <div class="muted">${escapeHtml(p.type||'')} • ${escapeHtml(p.authorName||'Unknown')} • ${dateStr}</div>
              </div>
              <div class="controls"></div>
            </div>
            <div style="margin-top:8px">${nl2br(escapeHtml(p.content||''))}</div>
          `;

          // show teacher-provided link first (Drive/URL). fallback to fileUrl if present (legacy)
          if(p.link){
            const fl = document.createElement('div'); fl.className='file-list';
            const a = document.createElement('a');
            a.href = p.link;
            a.target = '_blank';
            a.className = 'download';
            a.textContent = '🔗 Open Document';
            fl.appendChild(a); el.appendChild(fl);
          } else if(p.fileUrl){
            const fl = document.createElement('div'); fl.className='file-list';
            const a = document.createElement('a');
            a.href = p.fileUrl;
            a.target = '_blank';
            a.className = 'download';
            a.textContent = '📥 '+(p.fileName || 'Download');
            a.setAttribute('download', p.fileName || '');
            fl.appendChild(a); el.appendChild(fl);
          }

          // controls
          const ctr = el.querySelector('.controls');
          if(isTeacher){
            const del = document.createElement('button'); del.className='small secondary'; del.textContent='Delete';
            del.onclick = ()=> deletePost(p.id, p.filePath);
            ctr.appendChild(del);
          }

          // assignments (unchanged) - students can upload submissions
          if(p.type==='assignment'){
            const subDiv = document.createElement('div'); subDiv.style.marginTop='10px';
            if(!isTeacher){
              subDiv.innerHTML = `<input type="file" class="subFile" /><textarea class="subText" placeholder="Add notes (optional)" style="width:100%;margin-top:6px;padding:8px;border-radius:8px;border:1px solid #e6eef8"></textarea><div style="margin-top:6px"><button class="submitBtn">Submit Assignment</button></div>`;
              const submitBtn = subDiv.querySelector('.submitBtn');
              submitBtn.addEventListener('click', async ()=>{
                const fileInput = subDiv.querySelector('.subFile');
                const text = subDiv.querySelector('.subText').value;
                try{
                  let fileInfo = null;
                  if(fileInput.files && fileInput.files[0]){
                    const f = fileInput.files[0];
                    const path = `submissions/${p.id}/${currentUser.uid}_${Date.now()}_${sanitizeFilename(f.name)}`;
                    const sRef = storageRef(storage, path);
                    await uploadBytes(sRef, f);
                    const url = await getDownloadURL(sRef);
                    fileInfo = { fileName: f.name, filePath: path, fileUrl: url };
                  }
                  await addDoc(collection(db,'submissions'), { postId: p.id, postTitle: p.title, uid: currentUser.uid, name: currentName, text, created: serverTimestamp(), ...fileInfo });
                  alert('Submitted ✅');
                  fileInput.value=''; subDiv.querySelector('.subText').value='';
                }catch(err){ alert('Submit failed: '+err.message) }
              });
            } else {
              const view = document.createElement('div');
              view.innerHTML = `<button class="small">View submissions</button>`;
              view.querySelector('button').addEventListener('click', ()=> showSubmissionsForPost(p.id));
              subDiv.appendChild(view);
            }
            el.appendChild(subDiv);
          }

          // comments + replies for general posts
          if(p.type==='general'){
            const cDiv = document.createElement('div');
            cDiv.style.marginTop='10px';
            if(currentUser){
              cDiv.innerHTML = `
                <textarea class="cText" placeholder="Write a comment..." 
                  style="width:100%;margin-top:6px;padding:8px;border-radius:8px;border:1px solid #e6eef8"></textarea>
                <div style="margin-top:6px">
                  <button class="cBtn">Post Comment</button>
                </div>
                <div class="cList" style="margin-top:10px"></div>
              `;
              const cBtn = cDiv.querySelector('.cBtn');
              const cText = cDiv.querySelector('.cText');
              const cList = cDiv.querySelector('.cList');
              cBtn.addEventListener('click', async ()=>{
                const text = cText.value.trim();
                if(!text) return;
                try{
                  await addDoc(collection(db,'comments'), { postId: p.id, uid: currentUser.uid, name: currentName, text, created: serverTimestamp() });
                  cText.value='';
                }catch(err){ alert('Failed: '+err.message) }
              });

              // listen to all comments once and render top-level + replies grouped per post
              const cq = query(collection(db,'comments'), orderBy('created','asc'));
              onSnapshot(cq, snap=>{
                // collect comments for this post
                const all = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(c => c.postId === p.id);
                cList.innerHTML = '';

                // top-level comments (no replyTo)
                const top = all.filter(c => !c.replyTo);

                top.forEach(tc => {
                  const cmEl = document.createElement('div');
                  cmEl.className='muted';
                  cmEl.style.marginBottom='6px';
                  cmEl.innerHTML = `<strong>${escapeHtml(tc.name||'')}</strong>: ${escapeHtml(tc.text||'')}`;

                  // show replies (if any)
                  const replies = all.filter(r => r.replyTo === tc.id);
                  if(replies.length){
                    const rDiv = document.createElement('div');
                    rDiv.style.marginLeft='18px';
                    rDiv.style.marginTop='6px';
                    replies.forEach(r => {
                      const re = document.createElement('div');
                      re.className='muted';
                      re.style.marginBottom='4px';
                      re.innerHTML = `<strong>${escapeHtml(r.name||'')}</strong>: ${escapeHtml(r.text||'')}`;
                      rDiv.appendChild(re);
                    });
                    cmEl.appendChild(rDiv);
                  }

                  // reply box for this comment
                  const replyBox = document.createElement('div');
                  replyBox.className = 'replyBox';
                  replyBox.innerHTML = `<textarea class="rText" placeholder="Reply..." style="width:100%;padding:6px;border-radius:8px;border:1px solid #e6eef8"></textarea><button class="rBtn small">Reply</button>`;
                  replyBox.querySelector('.rBtn').addEventListener('click', async ()=>{
                    const rText = replyBox.querySelector('.rText').value.trim();
                    if(!rText) return;
                    try{
                      await addDoc(collection(db,'comments'), { postId: p.id, uid: currentUser.uid, name: currentName, text: rText, created: serverTimestamp(), replyTo: tc.id });
                      replyBox.querySelector('.rText').value = '';
                    }catch(err){ alert('Reply failed: '+err.message) }
                  });

                  cmEl.appendChild(replyBox);
                  cList.appendChild(cmEl);
                });

                // optionally show replies that accidentally have no parent (or parent deleted)
                const orphanReplies = all.filter(c => c.replyTo && !all.find(a => a.id === c.replyTo));
                orphanReplies.forEach(or => {
                  const orEl = document.createElement('div');
                  orEl.className = 'muted';
                  orEl.style.marginBottom = '6px';
                  orEl.style.marginLeft = '12px';
                  orEl.innerHTML = `<strong>${escapeHtml(or.name||'')}</strong>: ${escapeHtml(or.text||'')}`;
                  cList.appendChild(orEl);
                });
              });
            }
            el.appendChild(cDiv);
          }

          postsList.appendChild(el);
        });
      });
    }

    function showSubmissionsForPost(postId){
      const q = query(collection(db,'submissions'), orderBy('created','desc'));
      onSnapshot(q, snap=>{
        const subs = snap.docs.map(d=>({ id:d.id, ...d.data() })).filter(s=>s.postId===postId);
        const overlay = document.createElement('div'); overlay.style.position='fixed'; overlay.style.left=0; overlay.style.top=0; overlay.style.width='100%'; overlay.style.height='100%'; overlay.style.background='rgba(0,0,0,0.5)'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center';
        const box = document.createElement('div'); box.style.background='#fff'; box.style.padding='18px'; box.style.borderRadius='12px'; box.style.maxWidth='800px'; box.style.width='90%'; box.style.maxHeight='80%'; box.style.overflow='auto';
        box.innerHTML = `<h3>Submissions for post</h3>`;
        subs.forEach(s=>{
          const d = document.createElement('div'); d.className='card'; d.style.marginBottom='8px';
          d.innerHTML = `<div><strong>${escapeHtml(s.name||s.uid)}</strong> • <span class="muted">${s.created && s.created.toDate? s.created.toDate().toLocaleString() : ''}</span></div><div style="margin-top:6px">${escapeHtml(s.text||'')}</div>`;
          if(s.fileUrl){ const a = document.createElement('a'); a.href=s.fileUrl; a.target='_blank'; a.className='download'; a.textContent='📥 '+s.fileName; a.setAttribute('download', s.fileName); d.appendChild(a); }
          if(isTeacher){ const del = document.createElement('button'); del.className='small secondary'; del.style.marginLeft='8px'; del.textContent='Delete Submission'; del.onclick = ()=> deleteSubmission(s.id, s.filePath); d.appendChild(del); }
          box.appendChild(d);
        });
        const close = document.createElement('button'); close.textContent='Close'; close.className='small'; close.onclick = ()=> document.body.removeChild(overlay);
        box.appendChild(close);
        overlay.appendChild(box); document.body.appendChild(overlay);
      });
    }

    function loadActivity(){
      onSnapshot(collection(db,'activity'), snap=>{
        activityList.innerHTML='';
        snap.forEach(d=>{ const a=d.data(); const el=document.createElement('div'); el.className='muted'; el.style.marginBottom='6px'; el.textContent = `${a.msg || ''} ${a.by? '• '+a.by : ''}`; activityList.appendChild(el); });
      });
    }

    async function deletePost(postId, filePath){
      if(!confirm('Delete this post?')) return;
      try{
        if(filePath){ const fRef = storageRef(storage, filePath); await deleteObject(fRef).catch(()=>{}); }
        await deleteDoc(doc(db,'posts',postId));
        alert('Post deleted');
      }catch(err){ alert('Delete failed: '+err.message) }
    }

    async function deleteSubmission(subId, filePath){
      if(!confirm('Delete this submission?')) return;
      try{
        if(filePath){ const fRef = storageRef(storage, filePath); await deleteObject(fRef).catch(()=>{}); }
        await deleteDoc(doc(db,'submissions', subId));
        alert('Submission deleted');
      }catch(err){ alert('Delete failed: '+err.message) }
    }

    function nl2br(s){ return s.replace(/\n/g,'<br/>'); }
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"]+/g, function(match){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[match]) }); }
    function sanitizeFilename(name){ return name.replace(/[^a-zA-Z0-9._-]/g,'_'); }
  </script>
</body>
</html>
